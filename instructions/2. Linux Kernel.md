# Кастомное ядро Linux для сбора покрытия

Для сбора покрытия нужно включить поддержку `GCOV` и `debugfs` в ядре, а также заявить о необходимости собирать покрытие для `ext4`.

## Версия
Использовалась версия ядра 6.10.1 ([тэг](https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/tag/?h=v6.10.1) и [коммит](https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git/commit/?h=v6.10.1))

## Инструкции

Здесь пригодятся две статьи:
- [Как собрать кастомное ядро](https://phoenixnap.com/kb/build-linux-kernel).
- [Как настроить сбор покрытия](https://docs.kernel.org/dev-tools/gcov.html).


## Сборка ядра

Будем выполнять инструкцию по сборке кастомного ядра:

### Шаги 1-3

Выполняем полностью

### Шаг 4
В `menuconfig` настроим следующие переменные:
- `CONFIG_DEBUG_FS=y`
- `CONFIG_GCOV_KERNEL=y`
- `CONFIG_EXT4_FS=y`

В `fs/ext4/Makefile` добавим строчку:
- `"GCOV_PROFILE := y"`

### Шаг 5
Выполняем только первую часть:
```
make -jn
```
Где `n` - число доступных потоков + 1

### Дальнейшие шаги

После этого инструкцией предполагается установка ядра на машину, с помощью команды `make install`, однако нам нужно перенсти ядро на тестовую машину и установить уже там.


## Перенос ядра на тестовую машину

Собраем `.deb` пакеты для установки:
```
make -j9 bindeb-pkg
```

Они будут добавлены в директорию над той, в которой происходит сборка. Сложим их в одну директорию и пошарим с тестовой машиной.

На тестовой машине установим `.deb` пакеты:
```
# Это имя пошаренной папки
cd ~/linux-image
sudo dpkg -i *.deb
```

Перезагружаем `TM` и проверяем, что используется новое ядро:
```
sudo reboot
uname -r
```